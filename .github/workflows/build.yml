name: Build and Deploy Next.js Docker

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ดึงชื่อ Repo มาทำเป็นตัวเล็ก (Lowercase) เพื่อใช้เป็นชื่อ Image
      - id: string
        uses: ASzc/change-string-case-action@v1
        with:
          string: ${{ github.event.repository.name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ล็อกอินเข้า Docker Hub เพื่อเตรียม Push Image
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # ใส่ Secret เพิ่ม
          password: ${{ secrets.DOCKER_PASSWORD }} # ใส่ Secret เพิ่ม

      # สร้าง Docker Image และ Push ขึ้นไป
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: chunwarayut/${{ steps.string.outputs.lowercase }}:latest
          # ส่ง Build Args หรือ Secrets เข้าไปใน Dockerfile (ถ้าจำเป็น)
          build-args: |
             NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - id: string
        uses: ASzc/change-string-case-action@v1
        with:
          string: ${{ github.event.repository.name }}

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          # รวมคำสั่งทั้งหมดเป็น Script เดียว เพื่อลดการ Connect หลายรอบ
          script: |
            echo "Login into Docker Registry (Optional if public)..."
            # docker login ... (ถ้า Image เป็น Private)

            echo "Pulling new image..."
            docker pull chunwarayut/${{ steps.string.outputs.lowercase }}:latest

            echo "Stopping old container..."
            docker stop ${{ steps.string.outputs.lowercase }} || true
            docker rm ${{ steps.string.outputs.lowercase }} || true

            echo "Starting new container..."
            docker run --name ${{ steps.string.outputs.lowercase }} \
              --label io.portainer.accesscontrol.teams=discord \
              --restart=always -d \
              -p 7075:3000 \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e CFIMG="${{ secrets.CFIMG }}" \
              -e CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
              -e CLOUDFLARE_KEY="${{ secrets.CLOUDFLARE_KEY }}" \
              -e CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -e MAIL_USER="${{ secrets.MAIL_USER }}" \
              -e MAIL_PASS="${{ secrets.MAIL_PASS }}" \
              -e NEXT_PUBLIC_BASE_URL="${{ secrets.NEXT_PUBLIC_BASE_URL }}" \
              -e NODE_ENV="production" \
              --memory=512m --memory-swap=512m --cpus=1.5 \
              --log-opt max-size=10m --log-opt max-file=3 \
              chunwarayut/${{ steps.string.outputs.lowercase }}:latest

            echo "Cleaning up..."
            docker image prune -f
